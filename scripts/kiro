#!/usr/bin/env bash
set -euo pipefail

print_help() {
	cat <<'EOF'
Kiro SDD helper

Usage:
  ./scripts/kiro spec:validate --ttl <file.ttl> --csv <file.csv> --puml <file.puml> --mmd <file.mmd> --dot <file.dot> [--shapes <file.ttl>]
  ./scripts/kiro spec:sync --ontology <file.ttl> --csv <file.csv> --dict <file.md>
  ./scripts/kiro spec:derive --all

Notes:
  - This is a lightweight local wrapper for spec validation/sync operations in this repo.
  - For full Spec-Driven workflows, use the cc-sdd-provisioned slash commands in Cursor:
      /kiro:steering
      /kiro:spec-init <desc>
      /kiro:spec-requirements <feature>
      /kiro:spec-design <feature> [-y]
      /kiro:spec-tasks <feature> [-y]
      /kiro:spec-impl <feature> [tasks]
      /kiro:validate-*
EOF
}

require_arg() {
	local name="$1"; local value="${2:-}"
	if [[ -z "${value}" ]]; then
		echo "Error: missing required argument ${name}" >&2
		exit 2
	fi
}

cmd="${1:-help}"
shift || true

case "${cmd}" in
	help|--help|-h)
		print_help
		;;

	spec:validate)
		ttl=""
		csv=""
		puml=""
		mmd=""
		dot=""
		shapes=""
		while [[ $# -gt 0 ]]; do
			case "$1" in
				--ttl) ttl="${2:-}"; shift 2 ;;
				--csv) csv="${2:-}"; shift 2 ;;
				--puml) puml="${2:-}"; shift 2 ;;
				--mmd) mmd="${2:-}"; shift 2 ;;
				--dot) dot="${2:-}"; shift 2 ;;
				--shapes) shapes="${2:-}"; shift 2 ;;
				*) echo "Unknown flag: $1" >&2; exit 2 ;;
			esac
		done
		require_arg "--ttl" "${ttl}"
		require_arg "--csv" "${csv}"
		require_arg "--puml" "${puml}"
		require_arg "--mmd" "${mmd}"
		require_arg "--dot" "${dot}"
		cmd=(python3 -m spoon_diversity.cli validate --ttl "${ttl}" --csv "${csv}" --puml "${puml}" --mmd "${mmd}" --dot "${dot}")
		if [[ -n "${shapes}" ]]; then
			cmd+=("--shapes" "${shapes}")
		fi
		"${cmd[@]}"
		;;

	spec:sync)
		ontology=""
		csv=""
		dict=""
		while [[ $# -gt 0 ]]; do
			case "$1" in
				--ontology) ontology="${2:-}"; shift 2 ;;
				--csv) csv="${2:-}"; shift 2 ;;
				--dict) dict="${2:-}"; shift 2 ;;
				*) echo "Unknown flag: $1" >&2; exit 2 ;;
			esac
		done
		require_arg "--ontology" "${ontology}"
		require_arg "--csv" "${csv}"
		require_arg "--dict" "${dict}"
		python3 -m spoon_diversity.cli sync --ontology "${ontology}" --csv "${csv}" --dict "${dict}"
		;;

	spec:derive)
		if [[ "${1:-}" != "--all" ]]; then
			echo "Usage: ./scripts/kiro spec:derive --all" >&2
			exit 2
		fi
		# Derive artifacts using Python helpers:
		# - JSON Schema from SHACL
		# - Regenerate data dictionary from ontology+CSV header
		python3 - <<'PYCODE'
from pathlib import Path
from spoon_diversity import validators

root = Path(".").resolve()
ttl = root / "spore_SpoonDiversityOntology_v0.4.ttl"
csv = root / "spoon_diversity_dataset_template_v0.4.csv"
shapes = root / "spoon_shapes_v0.4.ttl"
dict_out = root / "spoon_diversity_data_dictionary_v0.4.md"
schema_out = root / "spoon_diversity_schema_v0.4.json"

validators.generate_dictionary(csv, dict_out, ttl)
validators.generate_json_schema_from_shacl(shapes, schema_out)
print("âœ… spec:derive refreshed dictionary and JSON schema.")
PYCODE
		;;

	*)
		echo "Unknown command: ${cmd}" >&2
		print_help
		exit 2
		;;
esac


